<% layout("/layouts/boilerplate") -%>

<script>
    const mapToken = "<%= process.env.MAP_TOKEN %>";
    const coordinates = JSON.parse("<%- JSON.stringify(listing.geometry.coordinates) %>");
    console.log("Coordinates from EJS:", coordinates);
</script>

<div class="row mt-4 mb-4 justify-content-center">
    <!-- Image Card -->
    <div class="col-md-6 mb-4 d-flex">
        <div class="card shadow-sm flex-fill">
            <img src="<%= listing.image?.url || '/images/default.jpg' %>" 
                 class="card-img-top" 
                 style="height:100%; object-fit:cover; border-radius:5px;" 
                 alt="listing_image">
        </div>
    </div>

    <!-- Details Card -->
    <div class="col-md-6 mb-4 d-flex">
        <div class="card shadow-sm p-4 flex-fill d-flex flex-column justify-content-between">
            <div>
                <h3 class="card-title mb-3"><%= listing.title %></h3>
                <p class="card-text mb-2"><strong>Price:</strong> â‚¹<%= listing.price %></p>
                <p class="card-text mb-2"><strong>Owner:</strong> <%= listing.owner.username %></p>
                <p class="card-text mb-2"><strong>Description:</strong> <%= listing.description %></p>
                <p class="card-text mb-2"><strong>Location:</strong> <%= listing.location %>, <%= listing.country %></p>
            </div>

            <div style="display:flex; gap:10px; margin-top:15px;">
                <% if(currentUser && currentUser._id.equals(listing.owner._id)) { %>
                    <!-- Owner buttons -->
                    <a href="/listings/<%= listing._id %>/edit" 
                       class="owner-btn"
                       style="flex:1; text-align:center; text-decoration:none;">
                        Edit
                    </a>
                    <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" style="flex:1;">
                        <button type="submit" class="owner-btn delete-btn" style="width:100%;">Delete</button>
                    </form>
                <% } else { %>
                    <!-- Stripe Payment Form -->
                    <form action="/payment/create-checkout-session" method="POST" style="flex:1;">
                        <input type="hidden" name="totalPrice" value="<%= listing.price %>">
                        <button class="action-btn buy-btn" style="width:100%;">Buy Now</button>
                    </form>

                    <!-- Add to Cart -->
                    <form method="POST" action="/cart/add/<%= listing._id %>" style="flex:1;">
                        <button class="action-btn cart-btn" style="width:100%;">Add to Cart</button>
                    </form>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Map Section -->
<div class="col-10 offset-1 mb-4">
    <h4>Where you'll be</h4>
    <div id="map" style="height: 400px; width: 100%; border-radius:5px;"></div>
</div>

<!-- Mapbox CSS and JS -->
<head>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>
</head>
<script src="/js/map.js"></script>

<style>
    .card img {
        border-radius: 5px;
    }

    .row > .col-md-6 {
        display: flex;
    }

    .card.flex-fill {
        display: flex;
        flex-direction: column;
    }

    /* Buttons styles */
    .action-btn, .owner-btn {
        padding:10px;
        font-weight:600;
        font-size:1rem;
        border:none;
        border-radius:5px;
        transition: all 0.2s ease;
        cursor:pointer;
    }

    .buy-btn {
        background-color:#28a745;
        color:#fff;
    }

    .cart-btn {
        background-color:#007bff;
        color:#fff;
    }

    .owner-btn {
        background-color:#ffc107;
        color:#fff;
        display:inline-block;
    }

    .delete-btn {
        background-color:#dc3545;
        color:#fff;
    }

    /* Hover animations */
    .buy-btn:hover {
        background-color:#218838;
    }

    .cart-btn:hover {
        background-color:#0069d9;
    }

    .owner-btn:hover {
        background-color:#e0a800;
    }

    .delete-btn:hover {
        background-color:#c82333;
    }

    .d-flex > form {
        margin-right:10px;
    }
</style>
